<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tienda ‚Äî Miyotl</title>
  <meta name="description" content="Checkout con carrito, direcci√≥n, m√©todos de env√≠o y resumen de pedido. Estilo unificado con el cat√°logo.">

  <!-- Paleta y tokens alineados al cat√°logo -->
  <style>
    :root{
      /* Colores del cat√°logo (mismos nombres) */
      --brand-50:#F7EFE6; --brand-100:#F2E6D8; --brand-200:#EAD6C0; --brand-300:#DBBFA2;
      --brand-400:#C9A781; --brand-500:#2B0F3A; --brand-700:#1B0D28;
      --miyotl:#C53D8C; --ink:#140A1F;
      --rose:#E067C6; --rose-strong:#A83477; --muted:#8E8E8E;
      --bar:#F2CFE9;

      /* Derivados para checkout */
      --bg:#fff;
      --card:#fff;
      --ring:0 6px 18px rgba(0,0,0,.12);
      --ring-strong:0 12px 40px rgba(0,0,0,.18);
      --ok:#0a7b34;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    a{color:var(--miyotl); text-decoration:none}

    /* Header con banner similar al cat√°logo */
    header.headline{background:#e1d1bd}
    .top-banner{width:100%; height:200px; object-fit:cover; display:block; filter:saturate(.95)}
    .wrap{max-width:1100px; margin:-40px auto 24px; padding:0 16px; position:relative}

    /* Tarjetas estilo cat√°logo */
    .card{
      background:var(--card);
      border:2px solid var(--rose);
      border-radius:22px;
      box-shadow:var(--ring);
      overflow:hidden;
    }
    .card h3{margin:0 0 8px}
    .section{padding:16px 18px; border-top:1px solid var(--brand-100)}
    .section:first-child{border-top:0; border-radius:22px 22px 0 0}
    .section:last-child{border-radius:0 0 22px 22px}

    /* Layout */
    .grid{display:grid; grid-template-columns:1.3fr .9fr; gap:24px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* Texto y labels */
    .muted{color:var(--muted)}
    .small{font-size:12px}
    label{display:block; font-size:13px; color:var(--muted); margin:12px 0 6px}
    input,select{
      width:100%; padding:12px; border:2px solid var(--rose);
      border-radius:12px; background:#fff; outline:none;
    }
    input:focus,select:focus{border-color:var(--rose-strong); box-shadow:0 0 0 3px rgba(168,52,119,.12)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}

    /* Radios env√≠o en tarjetas ligeras */
    .radios{display:flex; flex-direction:column; gap:10px}
    .radio{
      display:flex; align-items:center; gap:12px; padding:10px;
      border:2px solid var(--rose); border-radius:14px; cursor:pointer; background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .radio input{width:auto}
    .pill{
      font-size:12px; padding:2px 10px; border-radius:999px;
      background:var(--bar); color:#2b2330; border:2px solid var(--rose);
      font-weight:800;
    }

    /* Botones estilo cat√°logo */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:2px solid var(--rose); border-radius:12px; padding:12px 14px;
      font-weight:800; cursor:pointer; background:#fff; color:#5A5A5A;
      transition:.15s transform;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--miyotl); border-color:var(--rose-strong); color:#fff}
    .btn.ok{background:var(--ok); color:#fff; border-color:#0b6c34}
    .btn.ghost{background:#fff}
    .btn.block{width:100%}

    /* Totales */
    .totals{display:flex; flex-direction:column; gap:8px}
    .totals .row{display:flex; justify-content:space-between}
    .hr{height:1px; background:var(--brand-100); margin:12px 0}
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-size:12px;
      padding:6px 10px; border-radius:999px; background:var(--bar);
      color:#2b2330; border:2px solid var(--rose); font-weight:800;
    }

    /* Items del carrito */
    .cart-item{
      display:grid; grid-template-columns:56px 1fr auto; gap:12px; align-items:center;
      padding:10px 0; border-top:1px solid var(--brand-100);
    }
    .cart-item:first-child{border-top:0}
    .thumb{
      width:56px; height:56px; border-radius:12px; background:#fff;
      background-size:cover; background-position:center;
      border:2px solid var(--rose);
    }
    .qty{display:inline-flex; align-items:center; border:2px solid var(--rose); border-radius:12px; overflow:hidden}
    .qty button{border:0; background:#fff; padding:6px 10px; cursor:pointer; font-weight:900}
    .qty input{width:44px; border:0; text-align:center}
    .danger{color:#a00}

    /* Bot√≥n volver (arriba a la izquierda) */
    .backbar{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
  </style>
</head>
<body>

  <!-- Banner superior igual que el cat√°logo -->
  <header class="headline">
    <img class="top-banner" src="assets/images/catalogo-banner.webp" alt="">
  </header>

  <div class="wrap">
    <div class="backbar">
      <a href="catalogo.html" class="btn">‚Üê Volver al cat√°logo</a>
      <span class="pill">Checkout</span>
      <span class="pill" id="cart-pill"><span data-cart-count>0</span> art√≠culo(s)</span>
    </div>

    <div class="grid">
      <!-- Columna izquierda: Datos y env√≠o -->
      <div class="left">
        <div class="card">
          <div class="section">
            <h3>Contacto</h3>
            <label for="email">Correo electr√≥nico</label>
            <input id="email" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email">
          </div>

          <div class="section">
            <h3>Enviar a</h3>
            <div class="row">      <div>        <label for="name">Nombre(s)</label>        <input id="name" placeholder="Nombre(s)" autocomplete="given-name">      </div>      <div>        <label for="apPat">Apellido paterno</label>        <input id="apPat" placeholder="Apellido paterno" autocomplete="family-name">      </div>    </div>    <div class="row">      <div>        <label for="apMat">Apellido materno</label>        <input id="apMat" placeholder="Apellido materno">      </div>      <div>        <label for="phone">Tel√©fono (WhatsApp)</label>        <input id="phone" placeholder="10 d√≠gitos" autocomplete="tel">      </div>    </div>
            <label for="street">Calle</label>
            <input id="street" placeholder="Calle">
            <div class="row">
              <div>
                <label for="numInt">N√∫mero interior</label>
                <input id="numInt" placeholder="Interior">
              </div>
              <div>
                <label for="numExt">N√∫mero exterior (opcional)</label>
                <input id="numExt" placeholder="Exterior (opcional)">
              </div>
            </div>
            <div class="row">
              <div>
                <label for="col">Colonia</label>
                <input id="col" placeholder="Colonia o barrio">
              </div>
              <div>
                <label for="zip">C.P.</label>
                <input id="zip" placeholder="C√≥digo postal">
              </div>
            </div>
            <div class="row">
              <div>
                <label for="city">Ciudad/Municipio</label>
                <input id="city" placeholder="Ciudad o municipio">
              </div>
              <div>
                <label for="state">Estado</label>
                <input id="state" placeholder="Estado">
              </div>
            </div>
          </div>

          <div class="section">
            <h3>M√©todos de env√≠o</h3>
            <div class="radios" id="shipping-radios">
              <label class="radio">
                <input type="radio" name="ship" value="pickup">
                <div>
                  <div><strong>Recoge personalmente</strong> <span class="pill">GRATIS</span></div>
                  <div class="muted small">Viveros del Roc√≠o, Tlalnepantla. Coordinamos por WhatsApp.</div>
                </div>
              </label>
              <label class="radio">
                <input type="radio" name="ship" value="eco">
                <div>
                  <div><strong>Env√≠o econ√≥mico</strong></div>
                  <div class="muted small">5 a 30 d√≠as h√°biles aprox.</div>
                </div>
                <div style="margin-left:auto;">$120.00</div>
              </label>
              <label class="radio">
                <input type="radio" name="ship" value="std">
                <div>
                  <div><strong>Env√≠o est√°ndar</strong></div>
                  <div class="muted small">3 a 6 d√≠as h√°biles aprox.</div>
                </div>
                <div style="margin-left:auto;">$180.00</div>
              </label>
              <label class="radio">
                <input type="radio" name="ship" value="exp">
                <div>
                  <div><strong>Env√≠o express</strong></div>
                  <div class="muted small">1 a 3 d√≠as h√°biles aprox.</div>
                </div>
                <div style="margin-left:auto;">$210.00</div>
              </label>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="section">
            <h3>Pago</h3>
            <p class="muted small">Todas las transacciones son seguras y est√°n encriptadas.</p>
            <div class="hr"></div>
            <p class="danger"><strong>Esta tienda no puede aceptar pagos en este momento.</strong></p>
            <p class="small muted">Puedes finalizar el pedido por WhatsApp o transferencia. El bot√≥n de abajo arma el resumen autom√°ticamente.</p>
            <button class="btn ok block" id="btn-wa">Finalizar por WhatsApp</button>
            <p class="small muted">Luego podemos integrar Mercado Pago/Stripe para pagar aqu√≠ mismo.</p>
          </div>
        </div>
      </div>

      <!-- Columna derecha: Resumen -->
      <div class="right">
        <div class="card">
          <div class="section" style="position:sticky; top:16px">
            <h3>Resumen de pedido</h3>
            <div id="cart-list"></div>
            <div class="hr"></div>
            <div class="totals">
              <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="row"><span>Env√≠o</span><strong id="shipcost">GRATIS</strong></div>
              <div class="row" style="font-size:18px"><span>Total</span><strong id="grand">$0.00</strong></div>
            </div>
            <p class="small muted">Incluye IVA cuando aplique. Jabones artesanales de glicerina.</p>
            <div class="badge" id="badge-info" style="display:none">Carrito demo precargado</div>
            <button id="clear-cart" class="btn ghost block" style="margin-top:8px">Vaciar carrito</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: motor intacto + mejoras (persistir env√≠o, validaci√≥n WA, vaciar carrito, seeding robusto) -->
  <script>
    /* =====================================================
       Checkout Miyotl ‚Äî v1.2 (visual unificado + fixes)
       ===================================================== */

    const TIER_LIMITS = { wholesale: 25, distributor: 100 };
    function tierFactor(t){ return t==='wholesale'?0.95 : (t==='distributor'?0.85:1); }
    function cartUnitsFrom(C){ return C.reduce((s,i)=> s + (Number(i.units_per_item||1) * Number(i.qty||0)), 0); }
    function currentTierFrom(C){ const u=cartUnitsFrom(C); if(u>=TIER_LIMITS.distributor) return 'distributor'; if(u>=TIER_LIMITS.wholesale) return 'wholesale'; return 'public'; }
    function appliedPrice(base,t){ return Math.round(Number(base||0)*tierFactor(t)*100)/100; }

    const SHIP_TABLE = {
      pickup: { label: 'Recoge personalmente', cost: 0 },
      eco:    { label: 'Env√≠o econ√≥mico', cost: 120 },
      std:    { label: 'Env√≠o est√°ndar', cost: 180 },
      exp:    { label: 'Env√≠o express', cost: 210 }
    };

    const MXN = n => n.toLocaleString('es-MX',{style:'currency',currency:'MXN'});

    const seedIfEmpty = () => {
      const existing = JSON.parse(localStorage.getItem('miyotl_cart')||'[]');
      if(existing.length) return existing;
      const demo = [
        {id:'frag-chocolate', name:'Fragancia/Aromatizante ‚Äî Chocolate', price:48, qty:1, img:'assets/images/102000.webp'},
        {id:'frag-menta', name:'Fragancia/Aromatizante ‚Äî Menta', price:48, qty:1, img:'assets/images/104000.webp'}
      ];
      localStorage.setItem('miyotl_cart', JSON.stringify(demo));
      return demo;
    };

    let CART = JSON.parse(localStorage.getItem('miyotl_cart') || '[]');
    if (!Array.isArray(CART)) CART = [];
    /* no seeding here: respetamos carrito vac√≠o */

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function saveCart(){ localStorage.setItem('miyotl_cart', JSON.stringify(CART)); }

    // Persistencia de env√≠o
    let shipKey = localStorage.getItem('miyotl_ship') || 'pickup';
    document.addEventListener('DOMContentLoaded', () => {
      const _shipInput = document.querySelector(`input[name="ship"][value="${shipKey}"]`);
      if (_shipInput) { _shipInput.checked = true; }
      updateTotals();
    });

    let _cartEventsBound = false;
    function attachQtyHandlers(){
      if (_cartEventsBound) return;
      _cartEventsBound = true;

      $('#cart-list').addEventListener('click', e=>{
        const btn = e.target.closest('[data-act]');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const idx = CART.findIndex(p=>p.id===id);
        if(idx<0) return;
        const act = btn.getAttribute('data-act');
        if(act==='inc') CART[idx].qty++;
        if(act==='dec') CART[idx].qty = Math.max(1, CART[idx].qty-1);
        if(act==='rm') CART.splice(idx,1);
        saveCart();
        renderCart();
      });

      $('#cart-list').addEventListener('input', e=>{
        const input = e.target;
        if(input.tagName!=='INPUT') return;
        const id = input.getAttribute('data-id');
        const idx = CART.findIndex(p=>p.id===id);
        let val = parseInt(input.value||'1',10);
        if(!Number.isFinite(val) || val<=0) val=1;
        CART[idx].qty = val;
        saveCart();
        updateTotals();
      });
    }

    function subtotal(){ const tier=currentTierFrom(CART); return CART.reduce((s,i)=>{ const base=(i.price_base_public!=null)?Number(i.price_base_public):Number(i.price||0); const price=appliedPrice(base,tier); i.price_applied=price; return s+price*Number(i.qty||0); },0);}

    function updateTotals(){
      miyotlUpdateCartBadge();
      const sub = subtotal();
      const ship = SHIP_TABLE[shipKey]?.cost || 0;
      $('#subtotal').textContent = MXN(sub);
      $('#shipcost').textContent = ship? MXN(ship) : 'GRATIS';
      $('#grand').textContent = MXN(sub + ship);
      // badge visible solo si hay items
      const b = document.getElementById('badge-info');
      if (b) b.style.display = CART.length? 'inline-flex':'none';
    }

    function renderCart(){
      try { CART = JSON.parse(localStorage.getItem('miyotl_cart') || '[]'); }
      catch(e){ CART = []; }
      if (!Array.isArray(CART)) CART = [];
      // No sembramos demo autom√°ticamente; si est√° vac√≠o, mostramos estado vac√≠o.

      const box = $('#cart-list');
      box.innerHTML='';
      if (!CART.length){
        const empty = document.createElement('div');
        empty.className='muted';
        empty.innerHTML = `<p>Tu carrito est√° vac√≠o.</p><p><a class="btn" href="catalogo.html">‚Üê Ir al cat√°logo</a></p>`;
        box.appendChild(empty);
        updateTotals();
        return;
      }
      CART.forEach(item=>{
        const row = document.createElement('div');
        row.className='cart-item';
        row.innerHTML = `
          <div class="thumb" style="background-image:url('${item.img||''}')"></div>
          <div>
            <div style="font-weight:700">${item.name}</div>
            <div class="muted small">${MXN(item.price)} c/u</div>
          </div>
          <div style="text-align:right">
            <div class="qty">
              <button aria-label="Menos" data-act="dec" data-id="${item.id}">‚àí</button>
              <input value="${item.qty}" inputmode="numeric" data-id="${item.id}" />
              <button aria-label="M√°s" data-act="inc" data-id="${item.id}">+</button>
            </div>
            <div class="small" style="margin-top:6px"><strong>${MXN(item.price*item.qty)}</strong></div>
            <button class="small" style="margin-top:6px;color:#a00;background:transparent;border:0;cursor:pointer" data-act="rm" data-id="${item.id}">Eliminar</button>
          </div>`;
        box.appendChild(row);
      });

      attachQtyHandlers();
      updateTotals();
    }
    window.renderCart = renderCart;
    miyotlUpdateCartBadge();

    // Listener de m√©todo de env√≠o (con persistencia)
    $$('#shipping-radios input[name="ship"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        shipKey = r.value;
        localStorage.setItem('miyotl_ship', shipKey);
        updateTotals();
      });
    });

    // Vaciar carrito
    const clearBtn = document.getElementById('clear-cart');
    if (clearBtn){
      clearBtn.addEventListener('click', ()=>{
        if(!confirm('¬øVaciar el carrito?')) return;
        localStorage.removeItem('miyotl_cart');
        CART = [];
        renderCart();
        updateTotals();
      });
    }

    // WhatsApp checkout con validaci√≥n m√≠nima
    $('#btn-wa').addEventListener('click', ()=>{
      const addr = { email: $('#email').value.trim(), name: $('#name').value.trim(), apPat: $('#apPat')?$('#apPat').value.trim():'', apMat: $('#apMat')?$('#apMat').value.trim():'', phone: $('#phone').value.trim(), street: $('#street').value.trim(), numInt: $('#numInt')?$('#numInt').value.trim():'', numExt: $('#numExt')?$('#numExt').value.trim():'', col: $('#col').value.trim(), zip: $('#zip').value.trim(), city: $('#city').value.trim(), state: $('#state').value.trim() };

      const required = [ ['name','Nombre(s)'], ['apPat','Apellido paterno'], ['apMat','Apellido materno'], ['phone','Tel√©fono'], ['street','Calle'], ['numInt','N√∫mero interior'], ['city','Ciudad/Municipio'], ['state','Estado'], ['col','Colonia'], ['zip','C.P.'] ].filter(([k])=>!addr[k]).map(([,label])=>label);

      if (required.length){
        alert('Faltan datos: ' + required.join(', '));
        return;
      }
      if (!CART.length){
        alert('Tu carrito est√° vac√≠o.');
        return;
      }

      const lines = [
        'üßº *Nuevo pedido Miyotl*',
        '\n*Contacto:* ' + addr.name + ' ' + addr.apPat + ' ' + addr.apMat + ' ‚Äî ' + addr.phone + ' ‚Äî ' + addr.email,
        '*Env√≠o:* ' + SHIP_TABLE[shipKey].label + ' (' + (SHIP_TABLE[shipKey].cost? MXN(SHIP_TABLE[shipKey].cost):'GRATIS') + ')',
        '*Direcci√≥n:* ' + addr.street + ' Int. ' + addr.numInt + (addr.numExt? (' Ext. ' + addr.numExt) : '') + ', Col. ' + addr.col + ', CP ' + addr.zip + ', ' + addr.city + ', ' + addr.state,
        '\n*Art√≠culos:*',
        ...CART.map(i=>'‚Ä¢ ' + i.name + ' √ó ' + i.qty + ' ‚Äî ' + MXN(i.price*i.qty)),
        '\n*Subtotal:* ' + MXN(subtotal()),
        '*Env√≠o:* ' + (SHIP_TABLE[shipKey].cost? MXN(SHIP_TABLE[shipKey].cost):'GRATIS'),
        '*Total:* ' + MXN(subtotal()+SHIP_TABLE[shipKey].cost)
      ];
      const text = encodeURIComponent(lines.join('\n'));
      const phone = '52XXXXXXXXXX'; // reemplaza por tu n√∫mero
      window.open('https://wa.me/' + phone + '?text=' + text, '_blank');
    });

    
    // === Contador global de carrito (siempre visible) ===
    function miyotlCartCount(){
      try{
        const c = JSON.parse(localStorage.getItem('miyotl_cart')||'[]');
        if(!Array.isArray(c)) return 0;
        return c.reduce((s,i)=> s + (parseInt(i.qty,10)||0), 0);
      }catch(e){ return 0; }
    }
    function miyotlUpdateCartBadge(){
      const n = miyotlCartCount();
      const el = document.querySelector('[data-cart-count]');
      if (el){ el.textContent = n; }
    }
    window.addEventListener('storage', (e)=>{
      if (e.key === 'miyotl_cart') miyotlUpdateCartBadge();
    });

    // Inicializar render
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>{ renderCart(); miyotlUpdateCartBadge(); });
    } else {
      renderCart();
    }
  </script>
</body>
</html>
